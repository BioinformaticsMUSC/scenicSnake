# Singularity Definition File for SCENIC Workflow
# Build with: singularity build scenic-workflow.sif Singularity.def

Bootstrap: docker
From: continuumio/miniconda3:latest

%labels
    Author Bryan Granger
    Description SCENIC Snakemake Workflow - Single-Cell Regulatory Network Analysis
    Version 1.0

%environment
    export DEBIAN_FRONTEND=noninteractive
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export PATH="/opt/conda/envs/scenic/bin:$PATH"

%post
    # Set timezone non-interactively to avoid tzdata prompts
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime
    echo "UTC" > /etc/timezone
    
    # Install system dependencies
    apt-get update && apt-get install -y \
        git \
        wget \
        curl \
        build-essential \
        libssl-dev \
        libffi-dev \
        libhdf5-dev \
        libcurl4-gnutls-dev \
        libxml2-dev \
        squashfs-tools \
        libcairo2-dev \
        libpango1.0-dev \
        libgdk-pixbuf-xlib-2.0-dev \
        libffi-dev \
        shared-mime-info \
        cmake \
        pkg-config \
        && rm -rf /var/lib/apt/lists/*

    # Create working directory
    mkdir -p /opt/scenic

    # Create SCENIC conda environment with base dependencies
    conda create -y -n scenic -c conda-forge -c anaconda -c bioconda \
        python=3.10 \
        snakemake-minimal>=7.0 \
        jupyter \
        pip

    # Clean up after conda install
    conda clean -afy

    # Verify environment was created and find python path
    ls -la /opt/conda/envs/
    ls -la /opt/conda/envs/scenic/bin/

    # Install latest packages via pip directly to the environment
    /opt/conda/envs/scenic/bin/python -m pip install \
            adjusttext==1.3.0 \
            aiohappyeyeballs==2.4.6 \
            aiohttp==3.11.12 \
            aiosignal==1.3.2 \
            anndata==0.11.3 \
            arboreto==0.1.6 \
            array-api-compat==1.10.0 \
            async-timeout==5.0.1 \
            attrs==25.1.0 \
            bokeh==3.6.3 \
            boltons==25.0.0 \
            certifi==2025.1.31 \
            charset-normalizer==3.4.1 \
            click==8.1.8 \
            cloudpickle==3.1.1 \
            contourpy==1.3.1 \
            ctxcore==0.2.0 \
            cycler==0.12.1 \
            cytoolz==1.0.1 \
            dask==2024.2.1 \
            dask-expr==0.5.3 \
            dill==0.3.9 \
            distributed==2024.2.1 \
            exceptiongroup==1.2.2 \
            fonttools==4.56.0 \
            frozendict==2.4.6 \
            frozenlist==1.5.0 \
            fsspec==2025.2.0 \
            h5py==3.13.0 \
            idna==3.10 \
            igraph==0.11.8 \
            importlib-metadata==8.6.1 \
            interlap==0.2.7 \
            jinja2==3.1.5 \
            joblib==1.4.2 \
            kiwisolver==1.4.8 \
            legacy-api-wrap==1.4.1 \
            llvmlite==0.44.0 \
            locket==1.0.0 \
            loompy==3.0.8 \
            louvain==0.8.2 \
            lz4==4.4.3 \
            markupsafe==3.0.2 \
            matplotlib==3.10.0 \
            msgpack==1.1.0 \
            multidict==6.1.0 \
            multiprocessing-on-dill==3.5.0a4 \
            natsort==8.4.0 \
            networkx==3.4.2 \
            numba==0.61.0 \
            numexpr==2.10.2 \
            numpy==1.26.0 \
            numpy-groupies==0.11.2 \
            packaging==24.2 \
            pandas==2.2.3 \
            partd==1.4.2 \
            patsy==1.0.1 \
            pillow==11.1.0 \
            propcache==0.2.1 \
            psutil==7.0.0 \
            pyarrow==19.0.1 \
            pycairo==1.27.0 \
            pynndescent==0.5.13 \
            pyparsing==3.2.1 \
            python-dateutil==2.9.0.post0 \
            pytz==2025.1 \
            pyyaml==6.0.2 \
            requests==2.32.3 \
            scanpy==1.11.0 \
            scikit-learn==1.5.2 \
            scipy==1.15.2 \
            seaborn==0.13.2 \
            session-info2==0.1.2 \
            six==1.17.0 \
            sortedcontainers==2.4.0 \
            statsmodels==0.14.4 \
            tblib==3.0.0 \
            texttable==1.7.0 \
            threadpoolctl==3.5.0 \
            toolz==1.0.0 \
            tornado==6.4.2 \
            tqdm==4.67.1 \
            typing-extensions==4.12.2 \
            tzdata==2025.1 \
            umap-learn==0.5.7 \
            urllib3==2.3.0 \
            xyzservices==2025.1.0 \
            yarl==1.18.3 \
            zict==3.0.0 \
            zipp==3.21.0

    #install pyscenic separately via pip + git
    /opt/conda/envs/scenic/bin/python -m pip install git+https://github.com/aertslab/pySCENIC.git

    # Activate the environment by default
    echo "conda activate scenic" >> /opt/conda/etc/profile.d/conda.sh

    # Create necessary directories
    mkdir -p /opt/scenic/data \
             /opt/scenic/results \
             /opt/scenic/logs \
             /opt/scenic/envs \
             /opt/scenic/scripts \
             /opt/scenic/config

    # Create a simple environment file for reference
    cat > /opt/scenic/envs/scenic.yaml << EOF
name: scenic
channels:
  - conda-forge
  - anaconda
  - bioconda
dependencies:
  - python=3.9
  - snakemake-minimal>=7.0
  - jupyter
  - pip
  - pip:
    - adjusttext==1.3.0
    - aiohappyeyeballs==2.4.6
    - aiohttp==3.11.12
    - aiosignal==1.3.2
    - anndata==0.11.3
    - arboreto==0.1.6
    - array-api-compat==1.10.0
    - async-timeout==5.0.1
    - attrs==25.1.0
    - bokeh==3.6.3
    - boltons==25.0.0
    - certifi==2025.1.31
    - charset-normalizer==3.4.1
    - click==8.1.8
    - cloudpickle==3.1.1
    - contourpy==1.3.1
    - ctxcore==0.2.0
    - cycler==0.12.1
    - cytoolz==1.0.1
    - dask==2024.2.1
    - dask-expr==0.5.3
    - dill==0.3.9
    - distributed==2024.2.1
    - exceptiongroup==1.2.2
    - fonttools==4.56.0
    - frozendict==2.4.6
    - frozenlist==1.5.0
    - fsspec==2025.2.0
    - h5py==3.13.0
    - idna==3.10
    - igraph==0.11.8
    - importlib-metadata==8.6.1
    - interlap==0.2.7
    - jinja2==3.1.5
    - joblib==1.4.2
    - kiwisolver==1.4.8
    - legacy-api-wrap==1.4.1
    - llvmlite==0.44.0
    - locket==1.0.0
    - loompy==3.0.8
    - louvain==0.8.2
    - lz4==4.4.3
    - markupsafe==3.0.2
    - matplotlib==3.10.0
    - msgpack==1.1.0
    - multidict==6.1.0
    - multiprocessing-on-dill==3.5.0a4
    - natsort==8.4.0
    - networkx==3.4.2
    - numba==0.61.0
    - numexpr==2.10.2
    - numpy==1.26.0
    - numpy-groupies==0.11.2
    - packaging==24.2
    - pandas==2.0.3
    - partd==1.4.2
    - patsy==1.0.1
    - pillow==11.1.0
    - propcache==0.2.1
    - psutil==7.0.0
    - pyarrow==19.0.1
    - pycairo==1.27.0
    - pynndescent==0.5.13
    - pyparsing==3.2.1
    - python-dateutil==2.9.0.post0
    - pytz==2025.1
    - pyyaml==6.0.2
    - requests==2.32.3
    - scanpy==1.11.0
    - scikit-learn==1.5.2
    - scipy==1.15.2
    - seaborn==0.13.2
    - session-info2==0.1.2
    - six==1.17.0
    - sortedcontainers==2.4.0
    - statsmodels==0.14.4
    - tblib==3.0.0
    - texttable==1.7.0
    - threadpoolctl==3.5.0
    - toolz==1.0.0
    - tornado==6.4.2
    - tqdm==4.67.1
    - typing-extensions==4.12.2
    - tzdata==2025.1
    - umap-learn==0.5.7
    - urllib3==2.3.0
    - xyzservices==2025.1.0
    - yarl==1.18.3
    - zict==3.0.0
    - zipp==3.21.0
    - git+https://github.com/aertslab/pySCENIC.git
EOF

%files
    # Note: Files will be copied from the host during build if they exist
    # This is optional - the container will work without these files

%runscript
    # Default command - activate environment and run snakemake
    exec /opt/conda/envs/scenic/bin/snakemake "$@"

%help
    This container contains the SCENIC Snakemake workflow for single-cell regulatory network analysis.
    
    Built with all SCENIC dependencies pre-installed in a conda environment.
    
    Usage:
        singularity exec scenic-workflow.sif snakemake [options]
        
    Examples:
        singularity exec scenic-workflow.sif snakemake --help
        singularity exec scenic-workflow.sif snakemake -n --cores 1
        singularity exec scenic-workflow.sif snakemake --cores 8 --use-conda
        
    The conda environment 'scenic' contains:
    - Python 3.12
    - Snakemake >=7.0
    - scanpy, pySCENIC, loompy
    - All scientific Python stack