# Singularity Definition File for SCENIC Workflow
# Build with: singularity build scenic-workflow.sif Singularity.def

Bootstrap: docker
From: condaforge/mambaforge:latest

%labels
    Author Bryan Granger
    Description SCENIC Snakemake Workflow - Single-Cell Regulatory Network Analysis
    Version 1.0

%environment
    export DEBIAN_FRONTEND=noninteractive
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export PATH="/opt/conda/envs/scenic/bin:$PATH"

%post
    # Install system dependencies
    apt-get update && apt-get install -y \
        git \
        wget \
        curl \
        build-essential \
        libssl-dev \
        libffi-dev \
        libhdf5-dev \
        libcurl4-gnutls-dev \
        libxml2-dev \
        && rm -rf /var/lib/apt/lists/*

    # Create working directory
    mkdir -p /opt/scenic

    # Copy environment file and create conda environment
    # Note: In actual use, you'd copy the environment file during build
    # For now, we'll create a minimal SCENIC environment
    mamba install -n base -c bioconda -c conda-forge \
        snakemake \
        scanpy \
        loompy \
        pandas \
        numpy \
        matplotlib \
        seaborn \
        pyscenic \
        jupyter

    # Create necessary directories
    mkdir -p /opt/scenic/data \
             /opt/scenic/results \
             /opt/scenic/logs

%files
    # Copy workflow files (adjust paths as needed)
    envs/scenic.yaml /opt/scenic/envs/scenic.yaml

%runscript
    # Default command
    exec snakemake "$@"

%help
    This container contains the SCENIC Snakemake workflow for single-cell regulatory network analysis.
    
    Usage:
        singularity exec scenic-workflow.sif snakemake [options]
        
    Examples:
        singularity exec scenic-workflow.sif snakemake --help
        singularity exec scenic-workflow.sif snakemake -n --cores 1
        singularity exec scenic-workflow.sif snakemake --cores 8 --use-singularity