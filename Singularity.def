# Singularity Definition File for SCENIC Workflow
# Build with: singularity build scenic-workflow.sif Singularity.def

Bootstrap: docker
From: condaforge/mambaforge:latest

%labels
    Author Bryan Granger
    Description SCENIC Snakemake Workflow - Single-Cell Regulatory Network Analysis
    Version 1.0

%environment
    export DEBIAN_FRONTEND=noninteractive
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export PATH="/opt/conda/envs/scenic/bin:$PATH"

%post
    # Set timezone non-interactively to avoid tzdata prompts
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime
    echo "UTC" > /etc/timezone
    
    # Install system dependencies
    apt-get update && apt-get install -y \
        git \
        wget \
        curl \
        build-essential \
        libssl-dev \
        libffi-dev \
        libhdf5-dev \
        libcurl4-gnutls-dev \
        libxml2-dev \
        squashfs-tools \
        && rm -rf /var/lib/apt/lists/*

    # Create working directory
    mkdir -p /opt/scenic

    # Create SCENIC conda environment with base dependencies
    mamba create -y -n scenic -c conda-forge -c anaconda \
        python=3.9 \
        snakemake-minimal>=7.0 \
        loompy \
        pandas \
        numpy \
        seaborn \
        jupyter \
        h5py \
        scipy \
        scikit-learn \
        dask \
        cytoolz \
        pip

    # Clean up after conda install
    mamba clean -afy

    # Verify environment was created and find python path
    ls -la /opt/conda/envs/
    ls -la /opt/conda/envs/scenic/bin/

    # Install latest packages via pip directly to the environment
    /opt/conda/envs/scenic/bin/python -m pip install \
        "matplotlib<3.7" \
        scanpy \
        pyscenic \
        arboreto \
        ctxcore

    # Activate the environment by default
    echo "conda activate scenic" >> /opt/conda/etc/profile.d/conda.sh

    # Create necessary directories
    mkdir -p /opt/scenic/data \
             /opt/scenic/results \
             /opt/scenic/logs \
             /opt/scenic/envs \
             /opt/scenic/scripts \
             /opt/scenic/config

    # Create a simple environment file for reference
    cat > /opt/scenic/envs/scenic.yaml << EOF
name: scenic
channels:
  - conda-forge
  - anaconda
dependencies:
  - python=3.9
  - snakemake-minimal>=7.0
  - loompy
  - pandas
  - numpy
  - matplotlib<3.7
  - seaborn
  - jupyter
  - h5py
  - scipy
  - scikit-learn
  - dask
  - cytoolz
  - pip
  - pip:
    - scanpy
    - pyscenic
    - arboreto
    - ctxcore
EOF

%files
    # Note: Files will be copied from the host during build if they exist
    # This is optional - the container will work without these files

%runscript
    # Default command - activate environment and run snakemake
    exec /opt/conda/envs/scenic/bin/snakemake "$@"

%help
    This container contains the SCENIC Snakemake workflow for single-cell regulatory network analysis.
    
    Built with all SCENIC dependencies pre-installed in a conda environment.
    
    Usage:
        singularity exec scenic-workflow.sif snakemake [options]
        
    Examples:
        singularity exec scenic-workflow.sif snakemake --help
        singularity exec scenic-workflow.sif snakemake -n --cores 1
        singularity exec scenic-workflow.sif snakemake --cores 8 --use-conda
        
    The conda environment 'scenic' contains:
    - Python 3.9
    - Snakemake >=7.0
    - scanpy, pySCENIC, loompy
    - All scientific Python stack